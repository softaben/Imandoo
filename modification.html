<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="modificationTitle">Modifier le menu - Imandou Food</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root{
          --bg: #0f172a;
          --card: #0b1220;
          --text: #e2e8f0;
          --muted: #94a3b8;
          --accent: #fbbf24;
          --radius-lg: 14px;
          --radius-md: 8px;
          --success: #10b981;
          --danger: #ef4444;
          --info: #3b82f6;
        }
        
        body {
          font-family: 'Inter', 'Cairo', sans-serif;
          background: var(--bg);
          color: var(--text);
        }
        body::before {
          content: '';
          position: fixed; top: 0; left: 0;
          width: 100%; height: 100%;
          background-image: var(--background-image, url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&q=80&w=2070'));
          background-size: cover; background-position: center;
          opacity: 0.08; z-index: -1;
          transition: background-image 0.5s ease-in-out;
        }
        h1, h2, h3 { font-family: 'Playfair Display', serif; font-weight: 700; }
        [dir="rtl"] h1, [dir="rtl"] h2, [dir="rtl"] h3 { font-family: 'Cairo', sans-serif; }

        .card {
          background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.04));
          border-radius: var(--radius-lg);
          box-shadow: 0 8px 25px rgba(2,6,23,0.7);
          border: 1px solid rgba(255,255,255,0.04);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
        }
        .pill {
          background: rgba(255,255,255,0.03); border-radius: 999px;
          padding: 8px 16px; font-weight:500; color:var(--text);
          display:inline-flex; gap:8px; align-items:center;
          border: 1px solid rgba(255,255,255,0.05);
          transition: all 0.2s ease; cursor: pointer;
          font-size: 0.9rem; white-space: nowrap;
        }
        .pill:hover { background: rgba(255,255,255,0.07); transform: translateY(-1px); }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); display: flex;
            justify-content: center; align-items: center; z-index: 50;
            flex-direction: column;
            text-align: center;
        }
        .spinner {
          border: 4px solid rgba(255, 255, 255, 0.1);
          border-top: 4px solid var(--accent);
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-overlay" class="loading-overlay">
      <div class="spinner"></div>
      <p id="loading-text" class="text-white mt-4 text-lg" data-lang-key="loadingText"></p>
    </div>

    <header class="flex flex-col md:flex-row justify-between items-center mb-8 pb-4 border-b border-slate-800">
        <div class="flex items-center gap-4 mb-4 md:mb-0">
            <h1 class="text-3xl font-bold" data-lang-key="headerTitle">Modifier le menu</h1>
            <p class="text-[var(--muted)]" data-lang-key="headerSubtitle">Gérer les plats et les catégories</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="relative inline-block text-white">
                <select id="language-select" class="bg-slate-800 text-white rounded-full py-2 px-4 appearance-none cursor-pointer">
                    <option value="fr">Français</option>
                    <option value="ar">العربية</option>
                    <option value="en">English</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <i class="fas fa-caret-down text-white"></i>
                </div>
            </div>
            <a href="Dashboard.html" class="pill text-white hover:bg-slate-700 transition" data-lang-key="dashboardLink"><i class="fas fa-home"></i> <span></span></a>
            <a href="stats.html" class="pill text-white hover:bg-slate-700 transition" data-lang-key="statsLink"><i class="fas fa-chart-line"></i> <span></span></a>
            <a href="users.html" class="pill text-white hover:bg-slate-700 transition" data-lang-key="accountLink"><i class="fas fa-user-circle"></i> <span></span></a>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4" data-lang-key="menuTitle">Menu</h2>
                <div class="flex flex-col gap-4" id="menu-container">
                    </div>
            </div>
        </div>
        
        <div class="card p-6">
            <h2 class="text-2xl font-bold mb-4" data-lang-key="addItemTitle">Ajouter un nouvel article</h2>
            <form id="add-item-form" class="space-y-4">
                <div>
                    <label for="category" class="block text-sm font-medium text-[var(--muted)]" data-lang-key="categoryLabel"></label>
                    <select id="category" class="mt-1 block w-full bg-slate-800 text-white border border-slate-700 rounded-md shadow-sm p-2"></select>
                </div>
                <div>
                    <label for="name_fr" class="block text-sm font-medium text-[var(--muted)]" data-lang-key="nameFrLabel"></label>
                    <input type="text" id="name_fr" required class="mt-1 block w-full bg-slate-800 text-white border border-slate-700 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="name_ar" class="block text-sm font-medium text-[var(--muted)]" data-lang-key="nameArLabel"></label>
                    <input type="text" id="name_ar" required class="mt-1 block w-full bg-slate-800 text-white border border-slate-700 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="name_en" class="block text-sm font-medium text-[var(--muted)]" data-lang-key="nameEnLabel"></label>
                    <input type="text" id="name_en" required class="mt-1 block w-full bg-slate-800 text-white border border-slate-700 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="price" class="block text-sm font-medium text-[var(--muted)]" data-lang-key="priceLabel"></label>
                    <input type="number" id="price" required class="mt-1 block w-full bg-slate-800 text-white border border-slate-700 rounded-md shadow-sm p-2">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition" data-lang-key="addItemBtn"></button>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCyPOzsEzdrRd9o7iHASzFoLyJQhpTW83E",
          authDomain: "imandou-food.firebaseapp.com",
          databaseURL: "https://imandou-food-default-rtdb.firebaseio.com",
          projectId: "imandou-food"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentLang = 'fr';

        const translations = {
            'fr': {
                'modificationTitle': 'Modifier le menu - Imandou Food',
                'loadingText': 'Chargement des données...',
                'headerTitle': 'Modifier le menu',
                'headerSubtitle': 'Gérer les plats et les catégories',
                'dashboardLink': 'Tableau de bord',
                'statsLink': 'Statistiques',
                'accountLink': 'Mon compte',
                'menuTitle': 'Menu',
                'addItemTitle': 'Ajouter un nouvel article',
                'categoryLabel': 'Catégorie',
                'nameFrLabel': 'Nom du plat (Français)',
                'nameArLabel': 'Nom du plat (Arabe)',
                'nameEnLabel': 'Nom du plat (Anglais)',
                'priceLabel': 'Prix',
                'addItemBtn': 'Ajouter un article',
                'deleteBtn': 'Supprimer',
                'noItemsMessage': 'Aucun article dans cette catégorie pour le moment.',
                'deleteConfirm': 'Êtes-vous sûr de vouloir supprimer cet article ?'
            },
            'en': {
                'modificationTitle': 'Edit Menu - Imandou Food',
                'loadingText': 'Loading data...',
                'headerTitle': 'Edit Menu',
                'headerSubtitle': 'Manage dishes and categories',
                'dashboardLink': 'Dashboard',
                'statsLink': 'Statistics',
                'accountLink': 'My Account',
                'menuTitle': 'Menu',
                'addItemTitle': 'Add New Item',
                'categoryLabel': 'Category',
                'nameFrLabel': 'Dish Name (French)',
                'nameArLabel': 'Dish Name (Arabic)',
                'nameEnLabel': 'Dish Name (English)',
                'priceLabel': 'Price',
                'addItemBtn': 'Add Item',
                'deleteBtn': 'Delete',
                'noItemsMessage': 'No items in this category at the moment.',
                'deleteConfirm': 'Are you sure you want to delete this item?'
            },
            'ar': {
                'modificationTitle': 'تعديل القائمة - Imandou Food',
                'loadingText': 'جاري تحميل البيانات...',
                'headerTitle': 'تعديل القائمة',
                'headerSubtitle': 'إدارة الأطباق والفئات',
                'dashboardLink': 'لوحة التحكم',
                'statsLink': 'الإحصائيات',
                'accountLink': 'حسابي',
                'menuTitle': 'القائمة',
                'addItemTitle': 'إضافة طبق جديد',
                'categoryLabel': 'الفئة',
                'nameFrLabel': 'اسم الطبق (الفرنسية)',
                'nameArLabel': 'اسم الطبق (العربية)',
                'nameEnLabel': 'اسم الطبق (الإنجليزية)',
                'priceLabel': 'السعر',
                'addItemBtn': 'إضافة طبق',
                'deleteBtn': 'حذف',
                'noItemsMessage': 'لا توجد عناصر في هذه الفئة حاليا.',
                'deleteConfirm': 'هل أنت متأكد من حذف هذا العنصر؟'
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('lang') || 'fr';
            document.getElementById('language-select').value = savedLang;
            setLanguage(savedLang);
            loadSettingsAndOrders();
        });

        document.getElementById('language-select').addEventListener('change', (e) => {
            setLanguage(e.target.value);
            loadSettingsAndOrders();
        });

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];

            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            document.title = t.modificationTitle;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (el.tagName === 'A' || el.tagName === 'BUTTON') {
                    const span = el.querySelector('span');
                    if (span) {
                        span.textContent = t[key];
                    } else {
                        el.textContent = t[key];
                    }
                } else {
                    el.textContent = t[key];
                }
            });
            localStorage.setItem('lang', lang);
        }

        async function loadSettingsAndOrders() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            
            try {
                const settingsSnap = await database.ref('settings').once('value');
                applySettings(settingsSnap.val() || {});
                fetchMenuItems();
            } catch(error) {
                console.error("Error loading settings:", error);
                loadingOverlay.style.display = 'none';
            }
        }
        
        function applySettings(settings) {
            if (settings.backgroundImage) {
                document.body.style.setProperty('--background-image', `url('${settings.backgroundImage}')`);
            }
            if (settings.accentColor) {
                document.documentElement.style.setProperty('--accent', settings.accentColor);
            }
        }

        function fetchMenuItems() {
            const t = translations[currentLang];
            const menuRef = database.ref('menu');
            const menuContainer = document.getElementById('menu-container');
            menuContainer.innerHTML = '';
            
            const categorySelect = document.getElementById('category');
            categorySelect.innerHTML = '';

            menuRef.on('value', (snapshot) => {
                const menu = snapshot.val() || {};
                
                menuContainer.innerHTML = '';
                categorySelect.innerHTML = '';

                Object.keys(menu).forEach(categoryKey => {
                    const category = menu[categoryKey];
                    const categoryName = category.name;
                    
                    const option = document.createElement('option');
                    option.value = categoryKey;
                    option.textContent = categoryName;
                    categorySelect.appendChild(option);

                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'bg-slate-800 p-4 rounded-lg shadow';
                    categoryDiv.innerHTML = `<h3 class="text-xl font-semibold mb-2">${categoryName}</h3>`;

                    if (category.items) {
                        Object.keys(category.items).forEach(itemKey => {
                            const item = category.items[itemKey];
                            const itemName = item[`name_${currentLang}`] || item.name_fr;
                            const itemCard = document.createElement('div');
                            itemCard.className = 'flex items-center justify-between bg-slate-700 p-3 rounded-md mb-2';
                            itemCard.innerHTML = `
                                <div>
                                    <h4 class="font-medium">${itemName}</h4>
                                    <p class="text-sm text-[var(--muted)]">${item.price.toFixed(2)} MAD</p>
                                </div>
                                <button onclick="deleteMenuItem('${categoryKey}', '${itemKey}')" class="bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-700 transition" data-lang-key="deleteBtn">${t.deleteBtn}</button>
                            `;
                            categoryDiv.appendChild(itemCard);
                        });
                    } else {
                        const noItemsMsg = document.createElement('p');
                        noItemsMsg.className = 'text-center text-[var(--muted)]';
                        noItemsMsg.textContent = t.noItemsMessage;
                        categoryDiv.appendChild(noItemsMsg);
                    }
                    menuContainer.appendChild(categoryDiv);
                });
                document.getElementById('loading-overlay').style.display = 'none';
            });
        }

        document.getElementById('add-item-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const category = document.getElementById('category').value;
            const name_fr = document.getElementById('name_fr').value;
            const name_ar = document.getElementById('name_ar').value;
            const name_en = document.getElementById('name_en').value;
            const price = parseFloat(document.getElementById('price').value);

            const newItemRef = database.ref(`menu/${category}/items`).push();
            newItemRef.set({
                name_fr,
                name_ar,
                name_en,
                price
            });

            document.getElementById('add-item-form').reset();
        });

        function deleteMenuItem(categoryKey, itemKey) {
            const t = translations[currentLang];
            const confirmation = confirm(t.deleteConfirm);
            if (confirmation) {
                database.ref(`menu/${categoryKey}/items/${itemKey}`).remove();
            }
        }
    </script>
</body>
</html>
