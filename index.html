<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>قائمة طعام Imandou Food</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg: #0f172a;
      --card: #0b1220;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #fbbf24; /* سيتم تحديثه من Firebase */
      --radius-lg: 14px;
      --radius-md: 8px;
      --success: #10b981;
      --danger: #ef4444;
    }
    
    html,body{height:100%}
    body{
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: var(--background-image, url('https://images.unsplash.com/photo-1563245372-f21724e3856d?auto=format&fit=crop&w=2064&q=80'));
      background-size: cover; background-position: center;
      opacity: 0.08; z-index: -1; pointer-events: none;
      transition: background-image 0.5s ease-in-out;
    }

    .app { max-width: 480px; margin: 0 auto; min-height:100vh; position: relative; z-index: 1; }
    @media(min-width:768px){ .app{max-width:720px} }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03));
      border-radius: var(--radius-lg);
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
      backdrop-filter: blur(10px);
    }
    
    .pill {
      background: rgba(255,255,255,0.02); border-radius: 999px;
      padding: 8px 16px; font-weight:500; color:var(--text);
      display:inline-flex; gap:8px; align-items:center;
      border: 1px solid rgba(255,255,255,0.03);
      transition: all 0.2s ease; cursor: pointer;
      font-size: 0.9rem; white-space: nowrap;
    }
    .pill:hover { background: rgba(255,255,255,0.05); }
    .pill.active {
      background: var(--accent); color: #0f172a; font-weight: 600;
      box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    }
    .pill.primary { background: var(--accent); color: #0f172a; font-weight: 600; }
    .pill.secondary { background: rgba(255,255,255,0.05); }

    h1, h2, h3 { font-family: 'Playfair Display', serif; font-weight: 600; }
    [lang="ar"] body, [dir="rtl"] body { font-family: 'Cairo', 'Inter', sans-serif; }
    [lang="ar"] h1, [dir="rtl"] h1 { font-family: 'Cairo', 'Playfair Display', serif; }

    .categories-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
    .categories-bar::-webkit-scrollbar { display: none; }
    
    .menu-item-card { display: flex; gap: 12px; padding: 12px; transition: transform 0.2s ease; }
    .menu-item-card:hover { transform: translateY(-3px); }
    .menu-item-image { width: 100px; height: 100px; object-fit: cover; border-radius: var(--radius-md); flex-shrink: 0; }

    .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; margin-left: 6px; }
    .badge-spicy { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .badge-popular { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.3s ease; }
    .spinner { border: 4px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 4px solid var(--accent); width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* زر السلة العائم */
    .fab {
      position: fixed; bottom: 20px; right: 20px; z-index: 100;
      width: 60px; height: 60px; border-radius: 50%; background: var(--accent);
      color: var(--bg); display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: transform 0.2s ease, opacity 0.3s ease;
      transform: scale(0); opacity: 0;
    }
    .fab.visible { transform: scale(1); opacity: 1; }
    [dir="rtl"] .fab { right: auto; left: 20px; }
    .fab .badge-count {
      position: absolute; top: 0; right: 0;
      background: var(--danger); color: white;
      width: 22px; height: 22px; border-radius: 50%;
      font-size: 0.8rem; font-weight: bold;
      display: flex; align-items: center; justify-content: center;
      border: 2px solid var(--accent);
    }
    
    /* النافذة المنبثقة (Modal) */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: none;
      align-items: center; justify-content: center; z-index: 1000; padding: 20px;
      backdrop-filter: blur(5px);
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card); border-radius: var(--radius-lg);
      width: 100%; max-width: 500px; max-height: 90vh;
      display: flex; flex-direction: column;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);
    }
    .modal-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 1.5rem; font-weight: 700; margin: 0; }
    .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
    .modal-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items:center; gap: 10px; }
    .close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text); }
    
    /* عناصر السلة */
    .cart-item { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .cart-item-info { flex-grow: 1; }
    .quantity-controls { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); border-radius: 99px; padding: 4px; }
    .quantity-btn { width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.05); border: none; cursor: pointer; }
    
    /* حقول الإدخال */
    .form-input {
      background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
      border-radius: var(--radius-md); padding: 10px 12px; color: var(--text);
      width: 100%; margin-bottom: 12px;
    }
    .form-input:focus { outline: none; border-color: var(--accent); }

    /* رسائل Toast */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
    [dir="rtl"] .toast-container { right: auto; left: 20px; }
    .toast { padding: 12px 16px; border-radius: var(--radius-md); color: white; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .toast-success { background: var(--success); }
  </style>
</head>
<body>

  <div id="loader"><div class="spinner"></div></div>

  <div class="app p-4">
    <header class="text-center my-6">
      <h1 id="restaurantName" class="text-4xl font-bold tracking-tight">Imandou Food</h1>
      <p id="restaurantDescription" class="text-[var(--muted)] mt-2 text-lg">أهلاً بكم في مطعمنا</p>
    </header>

    <div class="flex justify-center gap-2 mb-6">
      <button class="pill lang-btn active" data-lang="ar">العربية</button>
      <button class="pill lang-btn" data-lang="en">English</button>
      <button class="pill lang-btn" data-lang="fr">Français</button>
    </div>

    <nav class="mb-6 sticky top-4 bg-[var(--bg)]/80 backdrop-blur-sm py-2 z-10 -mx-4 px-4">
        <div id="categoriesContainer" class="categories-bar"></div>
    </nav>
    
    <main id="menuContainer" class="grid grid-cols-1 gap-4 pb-24"></main>
  </div>

  <div id="cartFab" class="fab">
    <i class="fas fa-shopping-basket"></i>
    <span id="cartCount" class="badge-count">0</span>
  </div>
  
  <div id="cartModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="cartModalTitle" class="modal-title">سلة المشتريات</h3>
        <button class="close" onclick="closeCartModal()">&times;</button>
      </div>
      <div id="cartItems" class="modal-body"></div>
      <div class="modal-footer">
        <div>
          <span id="totalText">الإجمالي:</span>
          <strong id="cartTotal" class="text-xl">0 درهم</strong>
        </div>
        <button id="orderNowBtn" class="pill primary" onclick="showConfirmOrderModal()">
            <i class="fas fa-check"></i> <span id="orderBtnText">اطلب الآن</span>
        </button>
      </div>
    </div>
  </div>

  <div id="confirmOrderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="confirmModalTitle" class="modal-title">تأكيد الطلب</h3>
        <button class="close" onclick="closeConfirmOrderModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div>
          <label for="tableNumber" id="tableNumberLabel" class="block mb-2 font-medium">رقم الطاولة *</label>
          <input type="number" id="tableNumber" class="form-input text-lg" placeholder="e.g., 12">
        </div>
        <div>
          <label for="orderNotes" id="orderNotesLabel" class="block mb-2 font-medium">ملاحظات (اختياري)</label>
          <textarea id="orderNotes" class="form-input" rows="3" placeholder="مثال: بدون بصل، ..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
          <button class="pill secondary" onclick="closeConfirmOrderModal()"><span id="cancelBtnText">إلغاء</span></button>
          <button id="confirmOrderBtn" class="pill primary" onclick="submitOrder()">
              <i class="fas fa-paper-plane"></i> <span id="confirmOrderBtnText">تأكيد وإرسال الطلب</span>
          </button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCyPOzsEzdrRd9o7iHASzFoLyJQhpTW83E",
      authDomain: "imandou-food.firebaseapp.com",
      databaseURL: "https://imandou-food-default-rtdb.firebaseio.com",
      projectId: "imandou-food"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const menuRef = database.ref('menu');
    const categoriesRef = database.ref('categories');
    const settingsRef = database.ref('settings');
    const ordersRef = database.ref('orders');

    const loader = document.getElementById('loader');
    const restaurantNameEl = document.getElementById('restaurantName');
    const restaurantDescriptionEl = document.getElementById('restaurantDescription');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const menuContainer = document.getElementById('menuContainer');
    const langButtons = document.querySelectorAll('.lang-btn');
    const cartFab = document.getElementById('cartFab');
    const cartCount = document.getElementById('cartCount');
    const cartModal = document.getElementById('cartModal');
    const cartItemsContainer = document.getElementById('cartItems');
    const cartTotalEl = document.getElementById('cartTotal');
    const confirmOrderModal = document.getElementById('confirmOrderModal');

    let menuData = [];
    let categoriesData = [];
    let cart = [];
    let currentLang = 'ar';
    let currentCategory = 'all';

    const translations = {
        'all_categories': { 'ar': 'الكل', 'en': 'All', 'fr': 'Tout' },
        'spicy': { 'ar': 'حار', 'en': 'Spicy', 'fr': 'Épicé' },
        'popular': { 'ar': 'شائع', 'en': 'Popular', 'fr': 'Populaire' },
        'add_to_cart': { 'ar': 'إضافة', 'en': 'Add', 'fr': 'Ajouter' },
        'currency': { 'ar': 'درهم', 'en': 'MAD', 'fr': 'MAD' },
        'cart_title': { 'ar': 'سلة المشتريات', 'en': 'Your Cart', 'fr': 'Votre Panier' },
        'total': { 'ar': 'الإجمالي:', 'en': 'Total:', 'fr': 'Total:' },
        'order_now': { 'ar': 'اطلب الآن', 'en': 'Order Now', 'fr': 'Commander' },
        'empty_cart': { 'ar': 'سلتك فارغة.', 'en': 'Your cart is empty.', 'fr': 'Votre panier est vide.' },
        'confirm_order_title': { 'ar': 'تأكيد الطلب', 'en': 'Confirm Order', 'fr': 'Confirmer la commande' },
        'table_number': { 'ar': 'رقم الطاولة *', 'en': 'Table Number *', 'fr': 'Numéro de Table *' },
        'notes': { 'ar': 'ملاحظات (اختياري)', 'en': 'Notes (Optional)', 'fr': 'Notes (Optionnel)' },
        'cancel': { 'ar': 'إلغاء', 'en': 'Cancel', 'fr': 'Annuler' },
        'confirm_send': { 'ar': 'تأكيد وإرسال الطلب', 'en': 'Confirm & Send Order', 'fr': 'Confirmer & Envoyer' },
        'item_added': { 'ar': 'تمت إضافة الصنف للسلة', 'en': 'Item added to cart', 'fr': 'Article ajouté au panier' },
        'table_required': { 'ar': 'الرجاء إدخال رقم الطاولة', 'en': 'Please enter table number', 'fr': 'Veuillez entrer le numéro de table' },
        'order_placed': { 'ar': 'تم إرسال طلبك بنجاح!', 'en': 'Your order has been placed successfully!', 'fr': 'Votre commande a été passée avec succès!' },
        'order_failed': { 'ar': 'فشل إرسال الطلب. الرجاء المحاولة مرة أخرى.', 'en': 'Failed to place order. Please try again.', 'fr': 'Échec de la commande. Veuillez réessayer.' },
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        setupEventListeners();
    });

    async function loadData() {
        try {
            const [settingsSnapshot, categoriesSnapshot, menuSnapshot] = await Promise.all([
                settingsRef.once('value'),
                categoriesRef.once('value'),
                menuRef.once('value')
            ]);
            
            const settings = settingsSnapshot.val() || {};
            categoriesData = categoriesSnapshot.val() || [];
            menuData = menuSnapshot.val() || [];
            
            applySettings(settings);
            renderAll();

            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 300);
        } catch (error) {
            console.error("Error loading data: ", error);
            loader.innerHTML = "Failed to load menu.";
        }
    }

    function applySettings(settings) {
        if (settings.restaurantName) {
            restaurantNameEl.textContent = settings.restaurantName;
            document.title = `Menu - ${settings.restaurantName}`;
        }
        if (settings.restaurantDescription) {
            restaurantDescriptionEl.textContent = settings.restaurantDescription;
        }
        if (settings.backgroundImage) {
            document.body.style.setProperty('--background-image', `url('${settings.backgroundImage}')`);
        }
        if (settings.accentColor) {
            document.documentElement.style.setProperty('--accent', settings.accentColor);
        }
    }
    
    function setupEventListeners() {
        langButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                langButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentLang = btn.dataset.lang;
                document.documentElement.lang = currentLang;
                document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
                renderAll();
                updateUIText();
            });
        });
        cartFab.addEventListener('click', () => {
            if (cart.length > 0) cartModal.classList.add('active');
        });
    }

    function renderAll() {
        renderCategories();
        renderMenu();
        renderCart();
    }
    
    function updateUIText() {
        document.getElementById('cartModalTitle').innerText = translations.cart_title[currentLang];
        document.getElementById('totalText').innerText = translations.total[currentLang];
        document.getElementById('orderBtnText').innerText = translations.order_now[currentLang];
        document.getElementById('confirmModalTitle').innerText = translations.confirm_order_title[currentLang];
        document.getElementById('tableNumberLabel').innerText = translations.table_number[currentLang];
        document.getElementById('orderNotesLabel').innerText = translations.notes[currentLang];
        document.getElementById('cancelBtnText').innerText = translations.cancel[currentLang];
        document.getElementById('confirmOrderBtnText').innerText = translations.confirm_send[currentLang];
    }
    
    function renderCategories() {
        categoriesContainer.innerHTML = '';
        const allBtn = document.createElement('button');
        allBtn.className = `pill ${currentCategory === 'all' ? 'active' : ''}`;
        allBtn.textContent = translations.all_categories[currentLang];
        allBtn.onclick = () => { currentCategory = 'all'; renderAll(); };
        categoriesContainer.appendChild(allBtn);

        categoriesData.filter(cat => !cat.hidden).forEach(category => {
            const btn = document.createElement('button');
            const categoryName = category[`name_${currentLang}`] || category.name_en;
            btn.className = `pill ${currentCategory === category.name_ar ? 'active' : ''}`;
            btn.textContent = categoryName;
            btn.onclick = () => { currentCategory = category.name_ar; renderAll(); };
            categoriesContainer.appendChild(btn);
        });
    }

    function renderMenu() {
        menuContainer.innerHTML = '';
        const filteredMenu = menuData.filter(item => !item.hidden && (currentCategory === 'all' || item.category === currentCategory));
        
        filteredMenu.forEach(item => {
            const name = item[`name_${currentLang}`] || item.name_en;
            const desc = item[`desc_${currentLang}`] || item.desc_en;
            const card = document.createElement('div');
            card.className = 'card menu-item-card';
            card.innerHTML = `
                <img src="${item.image}" alt="${name}" class="menu-item-image">
                <div class="flex-1 flex flex-col">
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-semibold">${name}</h3>
                        <p class="text-lg font-bold text-[var(--accent)] whitespace-nowrap">${item.price} ${translations.currency[currentLang]}</p>
                    </div>
                    <p class="text-sm text-[var(--muted)] mt-1 mb-2 flex-grow">${desc}</p>
                    <div class="flex justify-between items-center">
                        <div>
                            ${item.spicy ? `<span class="badge badge-spicy">${translations.spicy[currentLang]}</span>` : ''}
                            ${item.popular ? `<span class="badge badge-popular">${translations.popular[currentLang]}</span>` : ''}
                        </div>
                        <button class="pill text-sm !px-4 !py-2" onclick="addToCart(${item.id})">
                            <i class="fas fa-plus"></i> ${translations.add_to_cart[currentLang]}
                        </button>
                    </div>
                </div>`;
            menuContainer.appendChild(card);
        });
    }

    function addToCart(itemId) {
        const item = menuData.find(i => i.id === itemId);
        const cartItem = cart.find(i => i.id === itemId);
        if (cartItem) {
            cartItem.quantity++;
        } else {
            cart.push({ ...item, quantity: 1 });
        }
        showToast(translations.item_added[currentLang], 'success');
        renderCart();
    }

    function updateQuantity(itemId, change) {
        const cartItem = cart.find(i => i.id === itemId);
        if (cartItem) {
            cartItem.quantity += change;
            if (cartItem.quantity <= 0) {
                cart = cart.filter(i => i.id !== itemId);
            }
        }
        renderCart();
    }

    function renderCart() {
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = `<p class="text-center text-[var(--muted)]">${translations.empty_cart[currentLang]}</p>`;
            cartFab.classList.remove('visible');
            document.getElementById('orderNowBtn').disabled = true;
        } else {
            cartItemsContainer.innerHTML = '';
            cart.forEach(item => {
                const name = item[`name_${currentLang}`] || item.name_en;
                const itemEl = document.createElement('div');
                itemEl.className = 'cart-item';
                itemEl.innerHTML = `
                    <img src="${item.image}" alt="${name}" class="w-16 h-16 object-cover rounded-md">
                    <div class="cart-item-info">
                        <h4 class="font-semibold">${name}</h4>
                        <p class="text-sm text-[var(--muted)]">${item.price * item.quantity} ${translations.currency[currentLang]}</p>
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)"><i class="fas fa-plus"></i></button>
                        <span class="font-bold w-6 text-center">${item.quantity}</span>
                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)"><i class="fas fa-minus"></i></button>
                    </div>
                `;
                cartItemsContainer.appendChild(itemEl);
            });
            cartFab.classList.add('visible');
            document.getElementById('orderNowBtn').disabled = false;
        }
        const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        cartTotalEl.textContent = `${total} ${translations.currency[currentLang]}`;
        cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
    }
    
    function submitOrder() {
        const tableNumber = document.getElementById('tableNumber').value;
        const notes = document.getElementById('orderNotes').value;

        if (!tableNumber) {
            alert(translations.table_required[currentLang]);
            return;
        }

        const order = {
            tableNumber,
            notes,
            items: cart.map(item => ({ id: item.id, name: item.name_ar, quantity: item.quantity, price: item.price })),
            totalPrice: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            status: 'new'
        };

        ordersRef.push(order)
            .then(() => {
                showToast(translations.order_placed[currentLang], 'success');
                cart = [];
                renderCart();
                closeConfirmOrderModal();
                closeCartModal();
                document.getElementById('tableNumber').value = '';
                document.getElementById('orderNotes').value = '';
            })
            .catch(error => {
                console.error("Order submission error: ", error);
                alert(translations.order_failed[currentLang]);
            });
    }

    function showToast(message, type) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function closeCartModal() { cartModal.classList.remove('active'); }
    function showConfirmOrderModal() {
        closeCartModal();
        confirmOrderModal.classList.add('active');
    }
    function closeConfirmOrderModal() { confirmOrderModal.classList.remove('active'); }

  </script>
</body>
</html>
